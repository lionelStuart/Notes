## 事务


### 1. 事务的概念

- 事务是将一系列读、写操作绑定为一个逻辑操作单元
- 事务执行要么全部成功，提交；要么失败，全部回滚或终止

### 2. 原则
- ACID 原子性，一致性，隔离性，持久性
    - 原子性： 当出错发生时，可以中止事务，丢弃写入的部分
    - 一致性： 在数据库事务中指代应用客户端的预期状态；异步复制中，指代副本一致性，最终一致性； 一致性hash; CAP中，线性化
    - 隔离性： 事务隔离级别； 同时运行的事务不会相互干扰，不可见
- BASE 基本可用，软状态

### 3. 事务隔离级别

| 事务隔离级别 | 脏读 | 不可重复读 | 幻读 | 策略             |
| ------------ | ---- | ---------- | ---- | ---------------- |
| 读未提交     | O    | O          | O    | -                |
| 不可重复读   | X    | O          | O    | 读提交，行锁     |
| 可重复读     | X    | X          | O    | 快照级隔离，MVCC |
| 串行化       | X    | X          | X    | 表锁             |

- 问题
  - 脏读： 可以读到尚未提交的数据
  - 不可重复读： 在一个事务中读取同一数据多次，不一致， 读到更新的值
  - 幻读： 在事务中出现未操作的数据，读到增加或删除值

- MVCC
  - 依靠版本控制，消除锁定，保证读写没有冲突
  - 使用create_version 和 delete_version
  - 更新，删除操作时指定删除版本号
  - 读取时，只读到未删除的一行

- mysql 事务问题
  - mysql RR是否解决了幻读问题
  - 可以说解决了一部分
  - mysql中存在当前读和镜像读两种方式
  - 对于事务而言，简单的select读操作都是镜像读，而写操作如update、insert则为当前读
  - 对当前读和当前读，事务都只读取自己看到的view，视为解决
  - 对update操作，是当前读，next-key locks(包含行锁和gap锁)，在更新操作时冲突会block，视为解决
  - 对当前读和镜像读，则存在前后数据不一致，比如在一个事务中使用select * ，update后再使用 select for update, 则两者select 结果不一致
  - 对多个事务，如果一个事务包含多条语句，从业务上可能存在有误的情况，比如对同一条数据做自增操作，不通过select for update 加锁，如果业务上实际只需要一次自增，则实际可能做了两次自增

- gap lock 加锁
  - 对有索引的情况，精确等值加记录锁， 对范围加gap lock
  - 对没有索引、不走索引，全表加记录锁、间隙加gap锁

